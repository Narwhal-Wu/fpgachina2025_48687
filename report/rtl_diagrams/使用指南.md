# RTL 设计图示使用指南

## 概述

本项目使用 Yosys + GraphViz 自动生成了五级流水线处理器及 SoC 各层级的 RTL 设计图示。所有图示文件位于 `report/rtl_diagrams/` 目录。

## 图示类型

### 1. 高层架构图

#### 流水线架构图
- **文件**: `pipeline_architecture.svg/png`
- **内容**: 展示五级流水线的整体架构，包括：
  - 五个流水线阶段 (IF, ID, EX, MEM, WB)
  - 流水线寄存器 (IF/ID, ID/EX, EX/MEM, MEM/WB)
  - 寄存器文件
  - 数据前推单元
  - 冒险检测单元
  - AHB 总线接口

#### SoC 系统架构图
- **文件**: `soc_architecture.svg/png`
- **内容**: 展示完整的 SoC 系统架构，包括：
  - myCPU 处理器核心
  - AHB 总线互连
  - 存储控制器 (IROM, BRAM)
  - 外设 (UART, 7-Segment, LED, 按键)
  - 时钟和复位系统

### 2. 流水线各阶段详细设计

#### Fetch 阶段 (1_fetch)
- PC 计数器逻辑
- AHB 指令接口状态机
- 分支跳转控制
- IF/ID 流水线寄存器

#### Decode 阶段 (2_decode)
- 指令译码逻辑
- 寄存器读取端口
- 立即数生成电路
- 冒险检测逻辑
- ID/EX 流水线寄存器

#### Execute 阶段 (3_execute)
- ALU 运算单元
- 分支条件判断
- 跳转地址计算
- 数据前推选择器
- EX/MEM 流水线寄存器

#### Memory 阶段 (4_memory)
- AHB 数据接口状态机
- Load/Store 控制逻辑
- 数据对齐电路
- MEM/WB 流水线寄存器

#### Writeback 阶段 (5_writeback)
- 写回数据选择
- 寄存器写使能生成

### 3. CPU 完整设计 (6_myCPU)
- 集成了所有五个流水线阶段
- 完整的寄存器文件实现
- 流水线控制逻辑
- 双 AHB 总线接口

### 4. AHB 总线子系统

#### AHB 互连 (7_ahb_interconnect)
- 地址译码器
- 数据多路复用器
- 从设备选择逻辑

#### BRAM 控制器 (8_ahb_bram_controller)
- AHB 协议状态机
- BRAM 读写接口
- 地址映射逻辑
- 字节使能控制

#### IROM 控制器 (9_ahb_irom_controller)
- AHB 协议状态机
- ROM 读取接口
- 地址映射逻辑

## 查看方式

### 方式一: 网页查看 (推荐)

1. 使用浏览器打开 `report/rtl_diagrams/index.html`
2. 页面提供了所有图示的在线查看和下载
3. 支持直接在浏览器中查看 SVG 格式图示

### 方式二: 独立查看

#### SVG 格式 (推荐)
- 使用浏览器直接打开 (Chrome, Firefox, Edge)
- 使用 Inkscape 编辑和查看
- 优点: 矢量图形，支持无损缩放

#### PNG 格式
- 使用任何图片查看器
- 适合插入文档 (Word, PowerPoint, LaTeX)
- 优点: 兼容性好，文件较小

#### DOT 格式
- GraphViz 源文件
- 可以使用 GraphViz 工具重新渲染
- 可以自定义样式和布局

### 方式三: 导入 Draw.io 编辑

1. 访问 https://app.diagrams.net/
2. File → Import from → Device
3. 选择 SVG 或 DOT 文件
4. 可以自由编辑和导出

## 在报告中使用

### 插入到 Markdown 文档

```markdown
## 系统架构

### 五级流水线架构
![流水线架构](rtl_diagrams/pipeline_architecture.svg)

### Fetch 阶段设计
![Fetch 阶段](rtl_diagrams/1_fetch.svg)
```

### 插入到 Word/PowerPoint

1. 选择 PNG 格式图片
2. 插入 → 图片 → 从文件
3. 选择对应的 `.png` 文件

### 插入到 LaTeX

```latex
\begin{figure}[htbp]
  \centering
  \includegraphics[width=0.8\textwidth]{rtl_diagrams/pipeline_architecture.png}
  \caption{五级流水线架构}
  \label{fig:pipeline}
\end{figure}
```

## 图示说明

### 图形元素含义

- **矩形框**: 逻辑门、寄存器、组合逻辑单元
- **菱形**: 多路选择器 (MUX)
- **圆形/椭圆**: 输入/输出端口
- **箭头**: 信号连接，箭头方向表示数据流向

### 颜色编码

- **蓝色**: 输入端口
- **红色**: 输出端口  
- **绿色**: 内部信号
- **黄色**: 状态寄存器
- **灰色**: 辅助逻辑

### 标签说明

- 端口名称: 显示在节点内部或旁边
- 位宽信息: 显示在连线标签中 (如 [31:0])
- 模块名称: 显示在矩形框内

## 重新生成图示

如果修改了 RTL 代码，需要重新生成图示:

```bash
cd /path/to/LibreCore
bash report/generate_rtl_diagrams.sh
```

脚本会自动:
1. 调用 Yosys 综合各个模块
2. 生成 DOT 格式的图示文件
3. 使用 GraphViz 转换为 SVG 和 PNG 格式
4. 保存到 `report/rtl_diagrams/` 目录

## 技术参数

### 生成工具版本
- Yosys: 0.33
- GraphViz: 自动检测系统版本
- 输出格式: DOT, SVG, PNG

### 图示分辨率
- SVG: 矢量格式，无限缩放
- PNG: 自动根据图示复杂度调整
- 大型图示 (如 myCPU) 可能需要高分辨率显示器查看细节

### 文件大小
- 简单模块 (writeback): ~50 KB (SVG)
- 中等模块 (fetch, decode): ~100-250 KB (SVG)
- 复杂模块 (execute, myCPU): ~500 KB - 3 MB (SVG)

## 常见问题

### Q: 图示太大，无法看清细节？
A: 使用 SVG 格式查看，支持无损缩放。在浏览器中可以使用 Ctrl + 鼠标滚轮放大。

### Q: 如何只生成某个模块的图示？
A: 编辑 `generate_rtl_diagrams.sh` 脚本，注释掉不需要生成的模块。

### Q: 可以自定义图示样式吗？
A: 可以。修改 DOT 文件中的样式参数，或使用 Draw.io 导入后自定义。

### Q: 图示中的信号名称太长，如何简化？
A: 可以在 Yosys 脚本中使用 `rename` 命令重命名信号，或在 DOT 文件中手动编辑。

## 参考资源

- Yosys 手册: http://www.clifford.at/yosys/documentation.html
- GraphViz 文档: https://graphviz.org/documentation/
- Draw.io 在线工具: https://app.diagrams.net/
- RISC-V 规范: https://riscv.org/specifications/

## 版本历史

- v1.0 (2025-10-19): 初始版本，包含所有主要模块的 RTL 图示
