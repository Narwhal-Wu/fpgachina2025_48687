digraph decode_module {
    rankdir=LR;
    bgcolor="white";
    node [fontname="Arial", fontsize=11];
    edge [fontname="Arial", fontsize=9];
    
    // Title
    label="译码模块 (Decode Stage)\n负责指令译码、寄存器读取和冒险检测";
    labelloc="t";
    fontname="Arial Bold";
    fontsize=14;
    
    // Input signals
    subgraph cluster_inputs {
        label="输入信号";
        labelloc="t";
        style="filled";
        fillcolor="#f0f8ff";
        color="#4169e1";
        penwidth=2;
        
        node [shape=ellipse, style="filled", fillcolor="#e6f3ff", 
              color="#4682b4", penwidth=2, fontsize=10];
        
        CLK [label="CLK"];
        IFID_PC [label="IF_ID_pc"];
        IFID_INST [label="IF_ID_inst\n指令"];
        RS1_DATA [label="rs1\n寄存器1"];
        RS2_DATA [label="rs2\n寄存器2"];
        EX_ALU [label="ID_EX_alu\nEX前递"];
        EXMEM_ALU [label="EX_MEM_alu\nMEM前递"];
        BR_TAKEN [label="branch_taken\n分支跳转"];
    }
    
    // Main module
    subgraph cluster_module {
        label="";
        style="rounded,filled";
        fillcolor="#fffaf0";
        color="#2e8b57";
        penwidth=3;
        
        node [shape=box, style="rounded,filled"];
        
        // Instruction decoder
        DEC [label="指令译码器\n• 识别指令类型\n• 提取 opcode\n• 提取 funct3/funct7", 
            fillcolor="#98fb98", color="#228b22", penwidth=2, fontsize=10];
        
        // Immediate generator
        IMM_GEN [label="立即数生成器\n• I型立即数\n• S型立即数\n• B型立即数\n• U型立即数\n• J型立即数", 
                fillcolor="#90ee90", color="#228b22", penwidth=2, fontsize=10];
        
        // Register address extraction
        REG_ADDR [label="寄存器地址提取\n• rs1 [19:15]\n• rs2 [24:20]\n• rd [11:7]", 
                 fillcolor="#98fb98", color="#228b22", penwidth=2, fontsize=10];
        
        // Forwarding unit
        FWD [label="数据前递单元\n• EX阶段前递\n• MEM阶段前递\n• 选择正确数据", 
            fillcolor="#ffe4e1", color="#ff6347", penwidth=2, fontsize=10];
        
        // Hazard detection
        HAZ [label="冒险检测单元\n• Load-Use检测\n• 生成bubble信号", 
            fillcolor="#ffe4e1", color="#ff6347", penwidth=2, fontsize=10];
        
        // Pipeline register
        IDEX [label="ID/EX 流水线寄存器\n• 指令\n• PC\n• 寄存器数据\n• 立即数\n• 控制信号", 
             fillcolor="#ffd700", color="#ff8c00", penwidth=2, fontsize=10];
    }
    
    // Output signals
    subgraph cluster_outputs {
        label="输出信号";
        labelloc="t";
        style="filled";
        fillcolor="#f0fff0";
        color="#228b22";
        penwidth=2;
        
        node [shape=ellipse, style="filled", fillcolor="#e6ffe6", 
              color="#2e8b57", penwidth=2, fontsize=10];
        
        IDEX_PC [label="ID_EX_pc"];
        IDEX_INST [label="ID_EX_inst"];
        IDEX_RS1 [label="ID_EX_rs1"];
        IDEX_RS2 [label="ID_EX_rs2"];
        IDEX_RD [label="ID_EX_rd"];
        IDEX_IMM [label="ID_EX_imm"];
        BUBBLE [label="Load_bubble\n冒险信号"];
    }
    
    // Input connections
    CLK -> IDEX [label="时钟", color="#ff8c00", penwidth=1.5];
    IFID_PC -> IDEX [color="#4169e1", penwidth=1.5, style="dashed"];
    IFID_INST -> DEC [label="指令", color="#4169e1", penwidth=2];
    IFID_INST -> IMM_GEN [color="#4169e1", penwidth=1.5];
    IFID_INST -> REG_ADDR [color="#4169e1", penwidth=1.5];
    IFID_INST -> HAZ [color="#4169e1", penwidth=1.5, style="dashed"];
    
    RS1_DATA -> FWD [color="#d2691e", penwidth=1.5];
    RS2_DATA -> FWD [color="#d2691e", penwidth=1.5];
    EX_ALU -> FWD [label="前递", color="#ff6347", penwidth=1.5, style="dashed"];
    EXMEM_ALU -> FWD [label="前递", color="#ff6347", penwidth=1.5, style="dashed"];
    
    BR_TAKEN -> IDEX [label="清空", color="#dc143c", penwidth=1.5, style="dotted"];
    
    // Internal connections
    DEC -> IDEX [label="控制信号", color="#228b22", penwidth=1.5];
    IMM_GEN -> IDEX [label="立即数", color="#228b22", penwidth=1.5];
    REG_ADDR -> IDEX [label="rd", color="#228b22", penwidth=1.5, style="dashed"];
    FWD -> IDEX [label="操作数", color="#228b22", penwidth=2];
    HAZ -> BUBBLE [color="#ff6347", penwidth=2];
    
    // Output connections
    IDEX -> IDEX_PC [color="#228b22", penwidth=1.5];
    IDEX -> IDEX_INST [color="#228b22", penwidth=1.5];
    IDEX -> IDEX_RS1 [color="#228b22", penwidth=2];
    IDEX -> IDEX_RS2 [color="#228b22", penwidth=2];
    IDEX -> IDEX_RD [color="#228b22", penwidth=1.5];
    IDEX -> IDEX_IMM [color="#228b22", penwidth=2];
}
