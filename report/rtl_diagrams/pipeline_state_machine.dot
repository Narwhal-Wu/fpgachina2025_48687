digraph pipeline_state_machine {
    rankdir=TB;
    node [shape=rectangle, style="rounded,filled", fontname="Arial", fontsize=12];
    edge [fontname="Arial", fontsize=10];
    
    // Set graph attributes
    graph [fontname="Arial", fontsize=14, label="Pipeline CPU State Machine Model", labelloc=t];
    
    // Define states
    RESET [label="RESET", fillcolor="#ff6b6b", fontcolor="white", penwidth=2];
    IF [label="IF\n(Instruction Fetch)", fillcolor="#4ecdc4", penwidth=2];
    ID [label="ID\n(Instruction Decode)", fillcolor="#45b7d1", penwidth=2];
    EX [label="EX\n(Execute)", fillcolor="#96ceb4", penwidth=2];
    MEM [label="MEM\n(Memory Access)", fillcolor="#ffeaa7", penwidth=2];
    WB [label="WB\n(Write Back)", fillcolor="#dfe6e9", penwidth=2];
    STALL [label="STALL\n(Pipeline Stall)", fillcolor="#fdcb6e", penwidth=2, style="rounded,filled,dashed"];
    FLUSH [label="FLUSH\n(Pipeline Flush)", fillcolor="#e17055", penwidth=2, style="rounded,filled,dashed"];
    
    // State transitions for normal flow
    RESET -> IF [label="Reset Done", color="#2d3436", penwidth=2];
    IF -> ID [label="Instruction Fetched", color="#0984e3"];
    ID -> EX [label="Decode Complete", color="#0984e3"];
    EX -> MEM [label="Execution Complete", color="#0984e3"];
    MEM -> WB [label="Memory Complete", color="#0984e3"];
    WB -> IF [label="Write Back Done,\nFetch Next", color="#0984e3"];
    
    // Hazard handling
    ID -> STALL [label="Load-Use Hazard", color="#d63031", style="dashed"];
    STALL -> ID [label="Hazard Resolved", color="#00b894", style="dashed"];
    
    // Branch handling
    EX -> FLUSH [label="Branch Misprediction", color="#d63031", style="dashed"];
    FLUSH -> IF [label="Flush Complete,\nJump to Target", color="#00b894", style="dashed"];
    
    // Self loop for continuous operation
    IF -> IF [label="PC Stall\n(Load-Use Hazard)", color="#636e72", style="dotted"];
    
    // Legend
    subgraph cluster_legend {
        label="Legend";
        fontname="Arial";
        style="filled,rounded";
        fillcolor="#f8f9fa";
        
        node [shape=rectangle, style="rounded,filled"];
        
        legend_normal [label="Normal Pipeline State", fillcolor="#4ecdc4", fontname="Arial"];
        legend_hazard [label="Hazard Handling State", fillcolor="#fdcb6e", style="rounded,filled,dashed", fontname="Arial"];
        legend_reset [label="Reset State", fillcolor="#ff6b6b", fontcolor="white", fontname="Arial"];
        
        legend_normal -> legend_hazard [style="invis"];
        legend_hazard -> legend_reset [style="invis"];
    }
}
